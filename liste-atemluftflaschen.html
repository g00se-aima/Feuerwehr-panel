<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Liste Atemluftflaschen</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
	<header>
		<div class="left-controls">
			<button class="btn btn-small" id="btn-uebersicht">Übersicht</button>
			<button class="btn btn-black" id="btn-hauptmenu" onclick="window.location.href='index.html'">Hauptmenu</button>
			<div class="meta" id="page-indicator"><span class="page-title">Liste Atemluftflaschen</span></div>
		</div>
		<div style="display:flex;align-items:center;gap:12px">
			<div style="position:relative">
				<input id="global-search" class="search-input" placeholder="Suche (Seiten & Inhalte)..." />
				<div id="search-dropdown" style="display:none;position:absolute;right:0;top:38px;background:#fff;border:1px solid #eee;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);z-index:100;width:360px;max-width:90vw;overflow:auto"></div>
			</div>
			<div style="display:flex;gap:8px;align-items:center">
				<button class="btn btn-small" id="btn-export">Backup download</button>
				<button class="btn btn-small" id="btn-import">Restore backup</button>
				<input type="file" id="import-file" style="display:none" accept=".json"/>
			</div>
		</div>
	</header>
	<main class="container">
		<div class="card">
			<div id="fl-btn-list"></div>
		</div>
	</main>
	<script>
		function renderFLLists() {
			if (typeof setupGlobalSearch === 'function') setupGlobalSearch();
			// Golden and grey FL numbers
			const goldenFL = [126,212,202,149,209,173,164,156,154,196,163,216,205,181,203,208,160,227,136,120,188,218,225,177,153,198,138,127,215,213,192,174,206,158,210,140,130,155,190,221,178,143,122,180,171,175,131,152,128,172,129,169,123,199,219,229,194,157,195,207,220,124,226,224,197,161,170,201,119,193,183,214,121,125,159,135,176,139,179,141,142,184,145,185,144,186,146,147,189,148,191,150,200,151,204,162,211,165,217,166,222,167,223,168,228,182,238,137,187,8,43,57,93,167,189,211,289];
			const greyFL = [73,24,61,22,85,19,71,70,1,102,16,82,26,29,9,46,17,72,53,86,84,116,118,40,8,51,11,57,33,59,66,93,79,81,44,42,4,6,10,12,13,14,15,18,20,21,23,25,27,28,30,31,32,34,35,36,43,48,49,52,56,60,64,65,67,69,75,76,77,78,87,88,91,95,100,101,104,105,107,108,109,110,111,112,113,114,115,117];
			let assignedFLLabels = [];
			const vehiclePages = [
				'1-hlf20-1.html','1-hlf20-2.html','1-hlf20-3.html','1-dlk23-1.html','1-tlf4000-1.html',
				'2-lf10-1.html','2-rw-1.html','3-hlf20-1.html','3-lfkat20.html','4-lf10-1.html','4-tlf3000-1.html','5-hlf20-1.html','gwg.html'
			];
			vehiclePages.forEach(page => {
				const moveablesKey = 'moveables_' + page;
				let moveables = [];
				try { moveables = JSON.parse(localStorage.getItem(moveablesKey) || '[]'); } catch (e) {}
				moveables.forEach(m => {
					if (m.areaId === 'fl' && m.label && m.label.startsWith('FL ')) {
						assignedFLLabels.push(m.label.trim());
					}
				});
			});
			// Also filter out FLs that have been removed from this page (persistently)
			let removedFLs = [];
			try { removedFLs = JSON.parse(localStorage.getItem('removed_fls_liste_atemluftflaschen') || '[]'); } catch (e) {}

			// Only render unassigned FL buttons in the list
			const unassignedGolden = goldenFL.filter(num => {
				const label = `FL ${num}`;
				return !assignedFLLabels.includes(label) && !removedFLs.includes(label);
			});
			const unassignedGrey = greyFL.filter(num => {
				const label = `FL ${num}`;
				return !assignedFLLabels.includes(label) && !removedFLs.includes(label);
			});

			// Render unassigned FLs in the list
			const container = document.getElementById('fl-btn-list');
			if (container) container.innerHTML = '';
			// Register the fl-btn-list as a moveable area (for home logic)
			let flBtnListArea = container;
			if (container && !container.classList.contains('moveable-area')) {
				const wrapper = document.createElement('div');
				wrapper.className = 'moveable-area';
				wrapper.dataset.areaId = 'fl-btn-list';
				container.parentNode.insertBefore(wrapper, container);
				wrapper.appendChild(container);
				flBtnListArea = wrapper;
			}
			if (window.registerArea) window.registerArea('fl-btn-list', flBtnListArea);
			if (window.renderMoveableButtons) {
				// Golden
				window.renderMoveableButtons(container, unassignedGolden, 'FL', 'fl-btn fl-gold', function(btn, num) {
					btn.style.border = '2px solid #bfa100';
					btn.style.color = '#fff';
					btn.style.background = '#bfa100';
					btn.style.fontWeight = 'bold';
					btn.style.margin = '6px';
					btn.style.minWidth = '54px';
					btn.style.minHeight = '44px';
					btn.style.fontSize = '1.1rem';
				});
				// Grey
				window.renderMoveableButtons(container, unassignedGrey, 'FL', 'fl-btn fl-grey', function(btn, num) {
					btn.style.border = '2px solid #888';
					btn.style.color = '#bbb';
					btn.style.background = '#444';
					btn.style.fontWeight = 'bold';
					btn.style.margin = '6px';
					btn.style.minWidth = '54px';
					btn.style.minHeight = '44px';
					btn.style.fontSize = '1.1rem';
				});
				// After rendering, re-dispatch input event on search bar to update search results
				const searchInput = document.getElementById('global-search');
				if (searchInput) {
					const event = new Event('input', { bubbles: true });
					searchInput.dispatchEvent(event);
				}
			}

			// Render removed FLs in the fl area (if present on this page)
			const flArea = document.querySelector('.moveable-area[data-area-id="fl"] .area-content');
			if (flArea) flArea.innerHTML = '';
			if (flArea && window.renderMoveableButtons) {
				const removedButNotAssigned = removedFLs.filter(label => !assignedFLLabels.includes(label));
				const removedNumbers = removedButNotAssigned.map(label => parseInt(label.replace('FL ', ''), 10)).filter(n => !isNaN(n));
				removedNumbers.forEach(num => {
					const btn = document.createElement('button');
					btn.textContent = 'FL ' + num;
					btn.className = 'btn fl-btn fl-grey';
					btn.style.border = '2px solid #888';
					btn.style.color = '#bbb';
					btn.style.background = '#444';
					btn.style.fontWeight = 'bold';
					btn.style.margin = '6px';
					btn.style.minWidth = '54px';
					btn.style.minHeight = '44px';
					btn.style.fontSize = '1.1rem';
					btn.addEventListener('dblclick', function(e) {
						let removedFLs = [];
						try { removedFLs = JSON.parse(localStorage.getItem('removed_fls_liste_atemluftflaschen') || '[]'); } catch (e) {}
						const label = 'FL ' + num;
						const idx = removedFLs.indexOf(label);
						if (idx !== -1) {
							removedFLs.splice(idx, 1);
							localStorage.setItem('removed_fls_liste_atemluftflaschen', JSON.stringify(removedFLs));
							renderFLLists();
						}
					});
					flArea.appendChild(btn);
				});
				// After rendering, re-dispatch input event on search bar to update search results
				const searchInput = document.getElementById('global-search');
				if (searchInput) {
					const event = new Event('input', { bubbles: true });
					searchInput.dispatchEvent(event);
				}
			}
		}
		document.addEventListener('DOMContentLoaded', renderFLLists);
	</script>
	<!-- modal editor -->
	<div id="modal" style="position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(12,12,18,0.45);display:none;align-items:center;justify-content:center;z-index:80" role="dialog" aria-hidden="true">
		<div style="background:#fff;padding:16px;border-radius:12px;min-width:320px;max-width:760px;box-shadow:0 10px 40px rgba(0,0,0,0.16)">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
				<strong id="modal-title">Editor</strong>
				<button class="btn btn-small" id="modal-close">Schließen</button>
			</div>
			<div id="modal-content"><div id="vehicle-list"></div>
				<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
					<input id="new-label" placeholder="Neuer Button-Text" style="padding:8px;border:1px solid #ddd;border-radius:6px"/>
					<input id="new-target" placeholder="Ziel-Seite (optional)" style="padding:8px;border:1px solid #ddd;border-radius:6px"/>
					<button class="btn btn-purple" id="add-vehicle">Hinzufügen</button>
				</div>
			</div>
			<div style="margin-top:12px;text-align:right"><button class="btn btn-small" id="modal-save">Fertig</button></div>
		</div>
	</div>
</body>
</html>
