<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Nummern PSA</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="left-controls">
      <button class="btn btn-small" onclick="window.location.href='uebersicht.html'">Ãœbersicht</button>
      <div class="meta">Seite: <strong>Nummern PSA</strong></div>
    </div>
  </header>
  <main class="container">
    <h1 class="page-title">Nummern PSA</h1>
    <div class="psa-container">
      <div style="flex:1;min-width:0;">
        <div class="psa-area">
          <div class="psa-area-title">Hauptwache</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=1;i<=60;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="Hauptwache">'+i+'</button>');}</script>
          </div>
        </div>
        <div class="psa-area">
          <div class="psa-area-title">LZ 1</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=100;i<=140;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="LZ 1">'+i+'</button>');}</script>
          </div>
        </div>
        <div class="psa-area">
          <div class="psa-area-title">LG 2</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=200;i<=240;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="LG 2">'+i+'</button>');}</script>
          </div>
        </div>
        <div class="psa-area">
          <div class="psa-area-title">LG 3</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=300;i<=400;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="LG 3">'+i+'</button>');}</script>
          </div>
        </div>
        <div class="psa-area">
          <div class="psa-area-title">LG 4</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=400;i<=440;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="LG 4">'+i+'</button>');}</script>
          </div>
        </div>
        <div class="psa-area">
          <div class="psa-area-title">LG 5</div>
          <div class="psa-area-btns" style="display:flex;flex-wrap:wrap;gap:8px;">
            <script>for(let i=500;i<=540;i++){document.write('<button class="psa-btn" draggable="true" data-original-area="LG 5">'+i+'</button>');}</script>
          </div>
        </div>
      </div>
      <div class="psa-dropzone" id="einsatz-dropzone">
          <button class="btn-einsatz-square" id="einsatz-square-btn" draggable="true">In laufenden Einsatz buchen</button>
        <!-- Dropped buttons will appear here -->
      </div>
    </div>
  </main>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Drag and drop logic for PSA buttons and Einsatz dropzone
  function addDragAndClick(btn) {
    btn.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', btn.textContent);
      e.dataTransfer.effectAllowed = 'move';
    });
    btn.addEventListener('click', function() {
      // Optionally handle click (e.g. rename, details)
    });
  }
  document.querySelectorAll('.psa-btn, .btn-einsatz-square').forEach(addDragAndClick);

  // Enable drop on einsatz-dropzone
  const einsatzDropzone = document.getElementById('einsatz-dropzone');
  einsatzDropzone.addEventListener('dragover', function(e) {
    e.preventDefault();
  });
  einsatzDropzone.addEventListener('drop', function(e) {
    e.preventDefault();
    const text = e.dataTransfer.getData('text/plain');
    // Find the button by text in all areas
    let btn = Array.from(document.querySelectorAll('.psa-btn')).find(b => b.textContent === text);
    if (btn) {
      // Move to dropzone
      btn.parentElement.removeChild(btn);
      einsatzDropzone.appendChild(btn);
    }
  });

  // Enable drop on each area
  document.querySelectorAll('.psa-area-btns').forEach(area => {
    area.addEventListener('dragover', function(e) {
      e.preventDefault();
    });
    area.addEventListener('drop', function(e) {
      e.preventDefault();
      const text = e.dataTransfer.getData('text/plain');
      let btn = Array.from(document.querySelectorAll('#einsatz-dropzone .psa-btn')).find(b => b.textContent === text);
      if (btn) {
        einsatzDropzone.removeChild(btn);
        area.appendChild(btn);
      }
    });
  });

  const einsatzBtn = document.getElementById('einsatz-square-btn');
  if (einsatzBtn) {
    einsatzBtn.textContent = 'In laufenden Einsatz buchen';
    einsatzBtn.dataset.num = 'Einsatz';
    einsatzBtn.addEventListener('click', function() {
      // Get all buttons in the dropzone
      const dropBtns = Array.from(document.querySelectorAll('#einsatz-dropzone .psa-btn'));

      // Visible debug output
      let debugHtml = '<div style="background:#ffe0e0;padding:8px;margin:8px 0;border:2px solid #c00;"><strong>PSA AREA DEBUG</strong><br>';
      debugHtml += '<u>Areas:</u><br>';
      Array.from(document.querySelectorAll('.psa-area')).forEach(div => {
        const title = div.querySelector('.psa-area-title');
        const btns = div.querySelector('.psa-area-btns');
        debugHtml += 'Area: <b>' + (title ? title.textContent.trim() : '[no title]') + '</b> | Has btns: ' + (!!btns) + '<br>';
      });
      debugHtml += '<u>Dropped buttons:</u><br>';
      dropBtns.forEach(btn => {
        debugHtml += 'Button: <b>' + btn.textContent + '</b> | data-original-area: <b>' + btn.dataset.originalArea + '</b><br>';
      });
      debugHtml += '</div>';
      document.body.insertAdjacentHTML('afterbegin', debugHtml);

      // Update localStorage (example logic, adjust as needed)
      const einsaetze = JSON.parse(localStorage.getItem('einsatz_list') || '[]');
      if (einsaetze.length === 0) {
        alert('Kein Einsatz vorhanden. Bitte zuerst einen Einsatz in Atemschutzeinsatz anlegen.');
        return;
      }
      const idx = einsaetze.length - 1; // last einsatz
      einsaetze[idx].nummern = Array.from(new Set([...(einsaetze[idx].nummern || []), ...dropBtns.map(b => b.textContent)]));
      localStorage.setItem('einsatz_list', JSON.stringify(einsaetze));

      // Move buttons back to their original area
      dropBtns.forEach(btn => {
        if (!btn) return;
        const originalArea = (btn.dataset.originalArea || '').trim();
        const targetAreaDiv = Array.from(document.querySelectorAll('.psa-area')).find(div => {
          const title = div.querySelector('.psa-area-title');
          return title && title.textContent.trim() === originalArea;
        });
        const areaBtns = targetAreaDiv ? targetAreaDiv.querySelector('.psa-area-btns') : null;
        if (targetAreaDiv) {
          if (areaBtns) {
            if (einsatzDropzone.contains(btn)) {
              einsatzDropzone.removeChild(btn);
            }
            areaBtns.appendChild(btn);
            // Sort after appending
            const btns = Array.from(areaBtns.querySelectorAll('.psa-btn'));
            btns.sort((a, b) => parseInt(a.textContent, 10) - parseInt(b.textContent, 10));
            btns.forEach(b => areaBtns.appendChild(b));
          } else {
            // Button stays in dropzone, no crash
            btn.style.background = 'red';
            let warn = document.createElement('div');
            warn.style.background = '#ffcccc';
            warn.style.color = '#900';
            warn.style.padding = '6px';
            warn.style.margin = '6px 0';
            warn.style.fontWeight = 'bold';
            warn.textContent = `FEHLER: Button ${btn.textContent} konnte nicht verschoben werden! Bereich: "${originalArea}" gefunden: true, Container: false`;
            document.body.insertAdjacentElement('afterbegin', warn);
          }
        } else {
          // Button stays in dropzone, no crash
          btn.style.background = 'red';
          let warn = document.createElement('div');
          warn.style.background = '#ffcccc';
          warn.style.color = '#900';
          warn.style.padding = '6px';
          warn.style.margin = '6px 0';
          warn.style.fontWeight = 'bold';
          warn.textContent = `FEHLER: Button ${btn.textContent} konnte nicht verschoben werden! Bereich: "${originalArea}" gefunden: false, Container: false`;
          document.body.insertAdjacentElement('afterbegin', warn);
        }
      });
    });
  }
});
</script>
</body>
</html>
