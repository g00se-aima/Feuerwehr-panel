<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Liste Technikflaschen</title>
<link rel="stylesheet" href="style.css" />
<script src="script.js"></script>
<script src="buttons.js"></script>
</head>
<body>
  <header>
    <div class="left-controls">
      <button class="btn btn-small" id="btn-uebersicht">Übersicht</button>
      <button class="btn btn-black" id="btn-hauptmenu" onclick="window.location.href='index.html'">Hauptmenu</button>
      <div class="meta" id="page-indicator"><span class="page-title">Liste Technikflaschen</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div style="position:relative">
        <input id="global-search" class="search-input" placeholder="Suche (Seiten & Inhalte)..." />
        <div id="search-dropdown" style="display:none;position:absolute;right:0;top:38px;background:#fff;border:1px solid #eee;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);z-index:100;width:360px;max-width:90vw;overflow:auto"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-small" id="btn-export">Backup download</button>
        <button class="btn btn-small" id="btn-import">Restore backup</button>
        <input type="file" id="import-file" style="display:none" accept=".json"/>
      </div>
    </div>
  </header>
  <main class="container">
    <div class="card">
      <div id="tf-btn-list"></div>
    </div>
  </main>
  <script>
    function renderTFLists() {
      if (typeof setupGlobalSearch === 'function') setupGlobalSearch();
      // Only TF logic remains. FL button logic has been removed.
      // Get all assigned TF labels from all vehicle pages
      const tfNumbers = [117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136];
      let assignedTFLabels = [];
      const vehiclePages = [
        '1-hlf20-1.html','1-hlf20-2.html','1-hlf20-3.html','1-dlk23-1.html','1-tlf4000-1.html',
        '2-lf10-1.html','2-rw-1.html','3-hlf20-1.html','3-lfkat20.html','4-lf10-1.html','4-tlf3000-1.html','5-hlf20-1.html','gwg.html'
      ];
      vehiclePages.forEach(page => {
        const moveablesKey = 'moveables_' + page;
        let moveables = [];
        try { moveables = JSON.parse(localStorage.getItem(moveablesKey) || '[]'); } catch (e) {}
        moveables.forEach(m => {
          if (m.areaId === 'technikflaschen' && m.label && m.label.startsWith('TF ')) {
            assignedTFLabels.push(m.label.trim());
          }
        });
      });
      // Also filter out TFs that have been removed from this page (persistently)
      let removedTFs = [];
      try { removedTFs = JSON.parse(localStorage.getItem('removed_tfs_liste_technikflaschen') || '[]'); } catch (e) {}

      // Only render unassigned TF buttons in the list
      const unassignedTFNumbers = tfNumbers.filter(num => {
        const label = `TF ${num}`;
        return !assignedTFLabels.includes(label) && !removedTFs.includes(label);
      });

      // Render unassigned TFs in the list as before
      const container = document.getElementById('tf-btn-list');
      if (container) container.innerHTML = '';
      // Register the tf-btn-list as a moveable area (for home logic)
      let tfBtnListArea = container;
      if (container && !container.classList.contains('moveable-area')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'moveable-area';
        wrapper.dataset.areaId = 'tf-btn-list';
        container.parentNode.insertBefore(wrapper, container);
        wrapper.appendChild(container);
        tfBtnListArea = wrapper;
      }
      if (window.registerArea) window.registerArea('tf-btn-list', tfBtnListArea);
      if (window.renderMoveableButtons) {
          window.renderMoveableButtons(container, unassignedTFNumbers, 'TF', 'tf-btn', function(btn, num) {
            btn.style.border = '2px solid #176a2a';
            btn.style.color = '#fff';
            btn.style.background = '#176a2a';
            btn.style.fontWeight = 'bold';
            btn.style.margin = '6px';
            btn.style.minWidth = '54px';
            btn.style.minHeight = '44px';
            btn.style.fontSize = '1.1rem';
          });
          // After rendering, re-dispatch input event on search bar to update search results
          const searchInput = document.getElementById('global-search');
          if (searchInput) {
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
          }
      }

      // Render removed TFs in the technikflaschen area (if present on this page)
      const technikflaschenArea = document.querySelector('.moveable-area[data-area-id="technikflaschen"] .area-content');
      if (technikflaschenArea) technikflaschenArea.innerHTML = '';
      if (technikflaschenArea && window.renderMoveableButtons) {
        const removedButNotAssigned = removedTFs.filter(label => !assignedTFLabels.includes(label));
        const removedNumbers = removedButNotAssigned.map(label => parseInt(label.replace('TF ', ''), 10)).filter(n => !isNaN(n));
        removedNumbers.forEach(num => {
          const btn = document.createElement('button');
          btn.textContent = 'TF ' + num;
          btn.className = 'btn tf-btn';
          btn.style.border = '2px solid #176a2a';
          btn.style.color = '#fff';
          btn.style.background = '#176a2a';
          btn.style.fontWeight = 'bold';
          btn.style.margin = '6px';
          btn.style.minWidth = '54px';
          btn.style.minHeight = '44px';
          btn.style.fontSize = '1.1rem';
          btn.addEventListener('dblclick', function(e) {
            let removedTFs = [];
            try { removedTFs = JSON.parse(localStorage.getItem('removed_tfs_liste_technikflaschen') || '[]'); } catch (e) {}
            const label = 'TF ' + num;
            const idx = removedTFs.indexOf(label);
            if (idx !== -1) {
              removedTFs.splice(idx, 1);
              localStorage.setItem('removed_tfs_liste_technikflaschen', JSON.stringify(removedTFs));
              renderTFLists();
            }
          });
          technikflaschenArea.appendChild(btn);
        });
        // After rendering, re-dispatch input event on search bar to update search results
        const searchInput = document.getElementById('global-search');
        if (searchInput) {
          const event = new Event('input', { bubbles: true });
          searchInput.dispatchEvent(event);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', renderTFLists);
  </script>
  <!-- modal editor -->
  <div id="modal" style="position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(12,12,18,0.45);display:none;align-items:center;justify-content:center;z-index:80" role="dialog" aria-hidden="true">
    <div style="background:#fff;padding:16px;border-radius:12px;min-width:320px;max-width:760px;box-shadow:0 10px 40px rgba(0,0,0,0.16)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong id="modal-title">Editor</strong>
        <button class="btn btn-small" id="modal-close">Schließen</button>
      </div>
      <div id="modal-content"><div id="vehicle-list"></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <input id="new-label" placeholder="Neuer Button-Text" style="padding:8px;border:1px solid #ddd;border-radius:6px"/>
          <input id="new-target" placeholder="Ziel-Seite (optional)" style="padding:8px;border:1px solid #ddd;border-radius:6px"/>
          <button class="btn btn-purple" id="add-vehicle">Hinzufügen</button>
        </div>
      </div>
      <div style="margin-top:12px;text-align:right"><button class="btn btn-small" id="modal-save">Fertig</button></div>
    </div>
  </div>
</body>
</html>
